services:
  # Super Productivity app
  app:
    image: johannesjo/super-productivity:latest
    ports:
      - '8091:80'
    networks:
      - super
      - frontend
    labels:
      # Enable Traefik for this container
      - "traefik.enable=true"
      # Define the router: name it 'pihole'
      - "traefik.http.routers.super_productivity-rtr.rule=Host(`super.kazasho.com`)"
      # Enable TLS
      - "traefik.http.routers.super_productivity-rtr.tls=true"
      - "traefik.http.routers.super_productivity-rtr.tls.certresolver=letencrypt"
      # Map the router to the 'websecure' entry point
      - "traefik.http.routers.super_productivity-rtr.entrypoints=websecure"
      # Define the service port (the port the application uses internally)
      - "traefik.http.services.super_productivity-svc.loadbalancer.server.port=80"
      # Pass the host header
      - "traefik.http.services.super_productivity-svc.loadbalancer.passhostheader=true"
      ## Middlewares
      #- "traefik.http.routers.super_productivity-rtr.middlewares=authentik-auth@file" 
    environment:
      # Pre-configured defaults for easier setup
      WEBDAV_BASE_URL: ${WEBDAV_BASE_URL:-http://localhost:2345/}
      WEBDAV_USERNAME: ${WEBDAV_USERNAME:-admin}
      WEBDAV_SYNC_FOLDER_PATH: ${WEBDAV_SYNC_FOLDER_PATH:-/}
      SYNC_INTERVAL: ${SYNC_INTERVAL:-15}
      IS_COMPRESSION_ENABLED: ${IS_COMPRESSION_ENABLED:-true}
      IS_ENCRYPTION_ENABLED: ${IS_ENCRYPTION_ENABLED:-false}

  # WebDAV sync server
  webdav:
    image: hacdias/webdav:latest
    ports:
      - '2345:2345'
    volumes:
      - ./webdav.yaml:/config.yml:ro
      - webdav_data:/data
    networks:
      - super
    healthcheck:
      test: ['CMD', 'wget', '--quiet', '--tries=1', '--spider', 'http://localhost:2345/']
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  webdav_data:

networks:
  frontend:
    name: frontend
    external: true
  super:
    name: super